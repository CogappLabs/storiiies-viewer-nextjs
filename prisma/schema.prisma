// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider   = "prisma-client"
  output     = "../src/generated/prisma"
  engineType = "client"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

enum ImageSourceType {
  url       // User directly entered an info.json URL
  manifest  // User selected from a manifest
  upload    // User uploaded a file
}

model ImageSource {
  id           String          @id @default(uuid())
  infoJsonUrl  String          @unique
  width        Int
  height       Int
  sourceType   ImageSourceType
  originalName String?         // For uploads: the original filename
  manifestUrl  String?         // For manifest sources: the manifest URL
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  story        Story?
}

model Story {
  id            String   @id @default(uuid())
  title         String
  author        String?
  description   String?
  attribution   String?
  imageSourceId String   @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  imageSource   ImageSource  @relation(fields: [imageSourceId], references: [id])
  annotations   Annotation[]
}

model Annotation {
  id        String   @id @default(uuid())
  storyId   String
  text      String
  // Rectangle drawn by user (in image pixel coordinates)
  x         Float
  y         Float
  width     Float
  height    Float
  // Viewport bounds when annotation was created (in image pixel coordinates)
  viewportX      Float?
  viewportY      Float?
  viewportWidth  Float?
  viewportHeight Float?
  ordinal   Int
  createdAt DateTime @default(now())

  story  Story             @relation(fields: [storyId], references: [id], onDelete: Cascade)
  images AnnotationImage[]

  @@index([storyId])
  @@index([storyId, ordinal])
}

model AnnotationImage {
  id           String   @id @default(uuid())
  annotationId String
  imageUrl     String
  ordinal      Int
  createdAt    DateTime @default(now())

  annotation Annotation @relation(fields: [annotationId], references: [id], onDelete: Cascade)

  @@index([annotationId])
  @@index([annotationId, ordinal])
}
